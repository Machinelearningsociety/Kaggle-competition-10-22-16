---
title: "Santander Data Exploration"
author: "Eve Ma"
date: "November 1, 2016"
output: HTML_document

---
##Background
The Santander bank data has monthly records of products a customer has. The goal of this competition is to predict which new Santander products a customer will buy in addition to what they already had at 2016-05-28.

###Load Packages
```{r message=FALSE, warning=FALSE}
#packages for getting and cleaning the data
library(data.table) #can read data faster
library(dplyr)  #working with data frames, very fast
library(tidyr) 
library(lubridate) #working with datas and times
library(ggplot2) 
library(rworldmap)
```

##Data Cleaning and Visualization
###Check the raw data
```{r message=FALSE, warning=FALSE}
set.seed(1)
train <- fread("C:/Users/Eve/Documents/kaggle/train_ver2.csv")
test <- fread("C:/Users/Eve/Documents/kaggle/test_ver2.csv")
```
```{r message=FALSE, warning=FALSE}
class(train)
dim(train)
glimpse(train) #within dplyr package
summary(train)
head(train)
tail(train)
```


```{r message=FALSE, warning=FALSE}
unique.id <- unique(train$ncodpers)
limit.people <- 2.5e5
unique.id <- unique.id[sample(length(unique.id),limit.people)]
train <- train[train$ncodpers %in% unique.id,]
```

###Check missing values
```{r message=FALSE, warning=FALSE}
sapply(train,function(x)any(is.na(x)))
checkmissingvalue <- sapply(train,function(x)any(is.na(x)))
missingvalue <- checkmissingvalue[checkmissingvalue=="TRUE"]
names(missingvalue)

missvals <- function(x){sum(is.na(x)/length(x))}
na.cols <- apply(X = train, MARGIN = 2, FUN = missvals)
na.cols <- data.frame(na.cols)
round(na.cols, 4)

row.names(na.cols)[na.cols > 0.20] #check to see which have more than 20% of row values as NAs

na.rows <- apply(X = train, MARGIN = 1, FUN = missvals) ## check which rows have many NAs
na.rows <- data.frame(na.rows)
sum(na.rows > 0.10)/dim(train)[1] ## about 0.21% of rows have 10% or more missing values
```

"age", "ind_nuevo", "antiguedad", "indrel", "tipodom", "cod_prov", "ind_actividad_cliente", "renta", "ind_nomina_ult1", "ind_nom_pens_ult1" These 10 columns have missing value.
"renta" column has more than 20% missing values
 
###Visualization
####Plot by age
```{r message=FALSE, warning=FALSE}
ggplot(data=train,aes(x=age)) + 
  geom_bar(alpha=0.75,fill="blue", color="dark blue") +
  ggtitle("Age Distribution") 
```

The distribution of age shows that there are few people with very young and old ages, the majority are people age between 20 and 30, and age around 50. So we separate the age into categories.

```{r message=FALSE, warning=FALSE}
train$age[(train$age < 18)] <- mean(train$age[(train$age >= 18) & (train$age <=30)],na.rm=TRUE)
train$age[(train$age > 100)] <- mean(train$age[(train$age >= 30) & (train$age <=100)],na.rm=TRUE)
train$age[is.na(train$age)] <- median(train$age,na.rm=TRUE)
train$age <- round(train$age)
```
plot again
```{r message=FALSE, warning=FALSE}
ggplot(data=train,aes(x=age)) + 
  geom_bar(alpha=0.75,fill="blue",color="dark blue") +
  xlim(c(18,100)) + 
  ggtitle("Age Distribution - adjusted")
```

####Plot by time period
Convert the date variables to standard Year-Month-Day format. 
```{r message=FALSE, warning=FALSE}
train$fecha_dato <- as.POSIXct(strptime(train$fecha_dato, format="%Y-%m-%d"))
train$fecha_alta <- as.POSIXct(strptime(train$fecha_alta, format="%Y-%m-%d"))
train$ult_fec_cli_1t <- as.POSIXct(strptime(train$ult_fec_cli_1t, format="%Y-%m-%d"))
unique(train$fecha_dato) #fecha_dato recorded on 28th each month
#(train$fecha_alta)[1:20]
#unique(train$ult_fec_cli_1t)[1:20]
```

Create year, month and week column
```{r message=FALSE, warning=FALSE}
#train$year_dato <- year(train$fecha_dato) # Extract year
train$year_alta <- year(train$fecha_alta)
#train$month_dato <- lubridate::month(train$fecha_dato,label=T) # Extract month
train$month_alta <- lubridate::month(train$fecha_alta,label=T)
#train$weekday_dato <- lubridate::wday(train$fecha_dato,label=T)
train$weekday_alta <- lubridate::wday(train$fecha_alta,label=T)
train <- as.data.table(train)
```

Plot Number of customers that became 'first holder' by day of week
```{r message=FALSE, warning=FALSE}
ggplot(train[,.N,by=weekday_alta],aes(x = weekday_alta,y = N,fill=weekday_alta))+
  geom_bar(stat="identity")+ggtitle("Number of customers that became 'first holder' by day of week")
```

Plot Number of customers that became 'first holder' by month and year
```{r message=FALSE, warning=FALSE}
ggplot(train[,.N,by=.(month_alta,year_alta)],aes(x = month_alta,y=N,fill=month_alta))+
  geom_bar(stat="identity")+ggtitle("Number of customers that became 'first holder' by month and year")+
  facet_wrap(~year_alta)
```

Since the month data are not significantly different before 2010, so we exclude those years.
```{r message=FALSE, warning=FALSE}
ggplot(train[year_alta>2010,.N,by=.(month_alta,year_alta)],aes(x = month_alta,y=N,fill=month_alta))+
  geom_bar(stat="identity")+ggtitle("Number of customers that became 'first holder' by month and year")+
  facet_wrap(~year_alta)
```

From July to December are high, October is the highest of each year.

####Mapping by region
```{r, message=FALSE, warning=FALSE}
country <- train[,.N,by=pais_residencia] # Number of customers by country
fr <- joinCountryData2Map(country, joinCode = "ISO2",nameJoinColumn = "pais_residencia",verbose=F) # Prepare data to plot

mapCountryData(mapToPlot = fr,nameColumnToPlot = "N",catMethod = "logFixedWidth",
                 oceanCol = "steelblue1",missingCountryCol = "white",
                 mapTitle = "Number of customers by country",
                 aspect = "variable") # Plot Worldmap
```

####Gross income of household
```{r, message=FALSE, warning=FALSE}
ggplot(data=train, aes(x=log(renta))) + 
  geom_bar(alpha=0.75,fill="red", color="black") +
  ggtitle("Gross Income of Household Distribution") 
#
```
